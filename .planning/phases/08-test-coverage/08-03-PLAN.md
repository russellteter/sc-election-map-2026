---
phase: 08-test-coverage
plan: 03
type: execute
depends_on: ["08-01", "08-02"]
files_modified: [__tests__/hooks/useAddressLookup.test.ts, __tests__/hooks/useVoterGuideData.test.ts]
---

<objective>
Integration tests for voter guide hooks - tests for useAddressLookup and useVoterGuideData with mocked dependencies.

Purpose: Ensure hooks correctly orchestrate validation, geocoding, and data loading with proper state management.
Output: Test suites for both hooks covering happy path and error scenarios.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/phases/08-test-coverage/08-01-SUMMARY.md
@.planning/phases/08-test-coverage/08-02-SUMMARY.md

# Source files to test:
@src/hooks/useAddressLookup.ts
@src/hooks/useVoterGuideData.ts

**Tech stack available:** Jest 30.2.0, @testing-library/react 16.3.1, ts-jest 29.4.6
**Established patterns:** renderHook from @testing-library/react, jest.mock for modules
**Dependencies to mock:**
- useAddressLookup: @/lib/geocoding, @/lib/districtLookup, @/lib/congressionalLookup, @/lib/addressValidation, next/navigation
- useVoterGuideData: global fetch
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useVoterGuideData test suite</name>
  <files>__tests__/hooks/useVoterGuideData.test.ts</files>
  <action>
    Create test file for useVoterGuideData hook:

    **Setup:**
    - Mock global fetch to return test JSON data
    - Mock window.location.pathname for GitHub Pages detection
    - Use renderHook from @testing-library/react

    **Test cases:**
    - 'should start with isLoading true and null data'
    - 'should load all data files in parallel'
    - 'should set isLoading false after data loads'
    - 'should handle fetch failures gracefully (null for failed files)'
    - 'should detect GitHub Pages base path from URL'

    **Test data:**
    Create minimal mock responses for each data type (candidates, statewide, etc.)

    Pattern:
    ```typescript
    import { renderHook, waitFor } from '@testing-library/react';
    import { useVoterGuideData } from '@/hooks/useVoterGuideData';

    describe('useVoterGuideData', () => {
      beforeEach(() => {
        global.fetch = jest.fn();
      });

      it('should load data successfully', async () => {
        (global.fetch as jest.Mock).mockResolvedValue({
          json: () => Promise.resolve({ /* mock data */ })
        });

        const { result } = renderHook(() => useVoterGuideData());

        expect(result.current.isLoading).toBe(true);

        await waitFor(() => {
          expect(result.current.isLoading).toBe(false);
        });

        expect(result.current.data.candidates).not.toBeNull();
      });
    });
    ```
  </action>
  <verify>npm test __tests__/hooks/useVoterGuideData.test.ts -- passes</verify>
  <done>useVoterGuideData hook fully tested</done>
</task>

<task type="auto">
  <name>Task 2: Create useAddressLookup test suite</name>
  <files>__tests__/hooks/useAddressLookup.test.ts</files>
  <action>
    Create test file for useAddressLookup hook:

    **Setup:**
    - Mock all dependencies: geocoding, districtLookup, congressionalLookup, addressValidation
    - Mock next/navigation useSearchParams
    - Mock localStorage (getItem, setItem, removeItem)
    - Mock window.location for URL manipulation

    **Test cases for handleAddressSubmit:**
    - 'should validate address before geocoding' - verify validateAddress called first
    - 'should set error state for invalid addresses' - empty, too short, etc.
    - 'should show warning but proceed for PO Box' - isWarning case
    - 'should geocode and find districts for valid addresses'
    - 'should set status through geocoding → finding-districts → done'
    - 'should handle geocoding errors' - map to user-friendly messages
    - 'should handle district lookup errors'
    - 'should persist address to localStorage on success'

    **Test cases for handleGeolocationRequest:**
    - 'should set isGeolocating during location fetch'
    - 'should reverse geocode and auto-submit'
    - 'should handle location permission denied'
    - 'should reject non-SC locations'

    **Test cases for handleReset:**
    - 'should clear all state and localStorage'
    - 'should clear URL parameters'

    **Test cases for URL/localStorage initialization:**
    - 'should auto-submit from URL parameter'
    - 'should auto-submit from localStorage if no URL param'
    - 'should prefer URL param over localStorage'

    Use jest.mock at top of file for all modules.
  </action>
  <verify>npm test __tests__/hooks/useAddressLookup.test.ts -- passes</verify>
  <done>useAddressLookup hook fully tested</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify coverage</name>
  <files>None (verification only)</files>
  <action>
    Run complete test suite:
    1. npm test -- verify all tests pass
    2. npm run test:coverage -- check coverage for new files

    Verify:
    - addressValidation.ts has >90% coverage
    - districtLookup.ts has >80% coverage
    - useAddressLookup.ts has >70% coverage (hooks are harder to cover fully)
    - useVoterGuideData.ts has >80% coverage

    Fix any failing tests or coverage gaps before completing.
  </action>
  <verify>npm run test:coverage shows good coverage for all new test files</verify>
  <done>All tests pass, coverage targets met</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm test passes all tests (including existing component tests)
- [ ] npm run test:coverage shows improved coverage
- [ ] No test pollution between suites
- [ ] All hook states tested (idle, geocoding, finding-districts, done, error)
</verification>

<success_criteria>
- useVoterGuideData tested for loading, success, and failure
- useAddressLookup tested for validation, geocoding, district lookup, geolocation, reset
- URL parameter and localStorage persistence tested
- All tests deterministic (proper mocking)
- Phase 8 complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-coverage/08-03-SUMMARY.md`:

# Phase 8 Plan 03: Hook Tests Summary

**[Substantive one-liner]**

## Accomplishments
- [Test suites created]
- [Coverage achieved]

## Files Created/Modified
- `__tests__/hooks/useVoterGuideData.test.ts`
- `__tests__/hooks/useAddressLookup.test.ts`

## Decisions Made
- [Mock strategy for hooks]

## Issues Encountered
- [Any hook testing challenges]

## Next Step
Phase 8 complete, ready for Phase 9: Performance Optimization
</output>
