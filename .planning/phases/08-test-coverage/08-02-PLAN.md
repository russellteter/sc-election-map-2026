---
phase: 08-test-coverage
plan: 02
type: execute
depends_on: []
files_modified: [__tests__/lib/districtLookup.test.ts]
---

<objective>
Unit tests for district lookup module - tests for findDistricts and preloadBoundaries functions with mocked GeoJSON.

Purpose: Ensure district lookup logic correctly handles point-in-polygon matching and edge cases.
Output: Complete test suite for districtLookup.ts with mocked fetch and GeoJSON data.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md

# Source file to test:
@src/lib/districtLookup.ts

**Tech stack available:** Jest 30.2.0, ts-jest 29.4.6
**Established patterns:** jest.mock for module mocking, describe blocks for grouping
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create district lookup test file with mock setup</name>
  <files>__tests__/lib/districtLookup.test.ts</files>
  <action>
    Create test file with:
    1. Mock global fetch to return test GeoJSON data
    2. Create minimal mock GeoJSON FeatureCollections for House and Senate (2-3 features each with simple polygon coordinates)
    3. Use Columbia, SC area coordinates for realistic test data (lat: 34.0007, lon: -81.0348)
    4. Reset mocks in beforeEach, clear district cache to ensure test isolation

    Mock GeoJSON structure:
    ```javascript
    const mockHouseDistricts = {
      type: 'FeatureCollection',
      features: [
        {
          type: 'Feature',
          properties: { SLDLST: '075' },
          geometry: {
            type: 'Polygon',
            coordinates: [[[-81.1, 33.9], [-81.0, 33.9], [-81.0, 34.1], [-81.1, 34.1], [-81.1, 33.9]]]
          }
        }
      ]
    };
    ```

    Note: The module caches boundaries, so tests need to clear the cache between test suites or mock differently to avoid state pollution.
  </action>
  <verify>Test file created, imports work, mock setup compiles</verify>
  <done>Test file exists with proper mock setup</done>
</task>

<task type="auto">
  <name>Task 2: Write findDistricts test cases</name>
  <files>__tests__/lib/districtLookup.test.ts</files>
  <action>
    Add test cases for findDistricts:

    **Success cases:**
    - 'should find both house and senate districts for valid coordinates' - mock returns both district matches
    - 'should return correct district numbers parsed from SLDLST/SLDUST properties' - verify parsing "075" to 75

    **Edge cases:**
    - 'should return null districts for coordinates outside all boundaries' - point outside all polygons
    - 'should return success: false when no districts found' - verify error message
    - 'should handle fetch failure gracefully' - mock fetch rejection, verify error message

    **Caching behavior:**
    - 'should cache boundaries after first load' - verify fetch called only once for multiple lookups
    - 'should handle concurrent requests with single fetch' - loadingPromise deduplication

    Use beforeEach to reset fetch mocks and module cache as needed.
  </action>
  <verify>npm test __tests__/lib/districtLookup.test.ts -- all tests pass</verify>
  <done>All findDistricts test cases pass</done>
</task>

<task type="auto">
  <name>Task 3: Write preloadBoundaries test cases</name>
  <files>__tests__/lib/districtLookup.test.ts</files>
  <action>
    Add test cases for preloadBoundaries:

    - 'should return true on successful preload' - mock successful fetch
    - 'should return false on failed preload' - mock fetch rejection
    - 'should not refetch if already loaded' - verify fetch not called twice

    Ensure tests don't interfere with findDistricts tests (module state management).
  </action>
  <verify>npm test __tests__/lib/districtLookup.test.ts -- all tests pass including preloadBoundaries</verify>
  <done>Complete test suite for districtLookup.ts passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm test __tests__/lib/districtLookup.test.ts passes all tests
- [ ] Tests cover success, failure, and edge cases
- [ ] Mocking is clean (no test pollution)
</verification>

<success_criteria>
- findDistricts tested for valid coordinates, invalid coordinates, fetch failures
- preloadBoundaries tested for success and failure
- Tests properly mock fetch and GeoJSON data
- No flaky tests (deterministic mock data)
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-coverage/08-02-SUMMARY.md`:

# Phase 8 Plan 02: District Lookup Tests Summary

**[Substantive one-liner]**

## Accomplishments
- [List test cases created]

## Files Created/Modified
- `__tests__/lib/districtLookup.test.ts` - Complete test suite

## Decisions Made
- [Mock strategy decisions]

## Issues Encountered
- [Any test isolation or mocking challenges]

## Next Step
Ready for 08-03-PLAN.md
</output>
