---
phase: 09-performance-optimization
plan: 01
type: execute
depends_on: []
files_modified:
  - src/lib/districtLookup.ts
  - src/lib/dataLoader.ts
  - src/lib/cacheUtils.ts
  - __tests__/lib/cacheUtils.test.ts
---

<objective>
Implement persistent caching for GeoJSON boundaries and JSON data files to eliminate redundant network requests across sessions.

Purpose: Currently all data is re-fetched on every page visit (~2MB GeoJSON + 100KB+ JSON). Persistent caching will provide instant loading for returning users.
Output: IndexedDB caching for GeoJSON, localStorage caching for JSON data, version-based cache invalidation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md

# Prior phase context (established patterns)
@.planning/phases/06-address-ux-improvements/06-01-SUMMARY.md

# Key files to modify
@src/lib/districtLookup.ts
@src/lib/dataLoader.ts

**Tech stack available:**
- React 19 + Next.js 16 (static export)
- localStorage already used for address persistence (Phase 6)
- IndexedDB - native browser API, no additional dependencies needed

**Established patterns:**
- SSR-safe localStorage: Check `typeof window !== 'undefined'` before access, try/catch for private browsing
- Progressive loading: Tier 1 (critical), Tier 2 (on-demand), Tier 3 (deferred)
- Singleton pattern for data loading (dataLoader.ts)

**Constraining decisions:**
- Phase 6: Store only strings in localStorage, not objects (simpler, more reliable)
- Architecture: Static export only, no server runtime

**Performance bottlenecks from CONCERNS.md:**
- GeoJSON Boundary Loading: ~2MB loaded when user focuses address input
- No Caching Between Sessions: All data re-fetched on each page visit (100KB+)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cache utilities with version tracking</name>
  <files>src/lib/cacheUtils.ts, __tests__/lib/cacheUtils.test.ts</files>
  <action>
Create a new `src/lib/cacheUtils.ts` module with:

1. **Cache version constant** - Increment to invalidate all caches:
   ```typescript
   export const CACHE_VERSION = '1.0.0';
   ```

2. **IndexedDB helpers for GeoJSON** (large data):
   - `openGeoJsonCache()` - Opens/creates IndexedDB database with version check
   - `getGeoJsonFromCache(key: string)` - Retrieves cached GeoJSON by key
   - `setGeoJsonInCache(key: string, data: FeatureCollection)` - Stores GeoJSON
   - DB name: `voter-guide-cache`, store name: `geojson`
   - Store version metadata in a `meta` store to compare with CACHE_VERSION

3. **localStorage helpers for JSON** (smaller data):
   - `getJsonFromCache<T>(key: string)` - Returns parsed JSON or null
   - `setJsonInCache(key: string, data: unknown)` - Stores stringified JSON with version
   - Key format: `vg-cache-{key}` with metadata: `{ version: CACHE_VERSION, data: ... }`
   - SSR-safe: Check `typeof window !== 'undefined'`, wrap in try/catch for private browsing

4. **Cache invalidation**:
   - `checkCacheVersion()` - Compares stored version with CACHE_VERSION, clears if mismatch
   - `clearAllCaches()` - Clears both IndexedDB and localStorage caches

Add comprehensive tests in `__tests__/lib/cacheUtils.test.ts`:
- Test localStorage get/set with mocked localStorage
- Test version mismatch triggers cache clear
- Test SSR safety (no errors when window undefined)
  </action>
  <verify>npm test -- --testPathPattern=cacheUtils --coverage</verify>
  <done>cacheUtils.ts exists with all helpers, tests pass with >90% coverage</done>
</task>

<task type="auto">
  <name>Task 2: Add IndexedDB persistence to districtLookup</name>
  <files>src/lib/districtLookup.ts</files>
  <action>
Modify `loadBoundaries()` in districtLookup.ts to use IndexedDB caching:

1. **Before network fetch, check IndexedDB**:
   ```typescript
   const cachedHouse = await getGeoJsonFromCache('sc-house-districts');
   const cachedSenate = await getGeoJsonFromCache('sc-senate-districts');
   if (cachedHouse && cachedSenate) {
     houseDistricts = cachedHouse;
     senateDistricts = cachedSenate;
     log('Loaded boundaries from IndexedDB cache');
     return;
   }
   ```

2. **After successful network fetch, cache to IndexedDB**:
   ```typescript
   await setGeoJsonInCache('sc-house-districts', houseDistricts);
   await setGeoJsonInCache('sc-senate-districts', senateDistricts);
   log('Cached boundaries to IndexedDB');
   ```

3. **Handle IndexedDB errors gracefully** - Fall back to network if cache fails:
   - Wrap cache reads in try/catch
   - Don't fail the whole lookup if caching fails
   - Log cache errors in debug mode

4. **Add cache initialization on module load**:
   - Call `checkCacheVersion()` once at module initialization
   - This ensures stale caches are cleared before any lookups
  </action>
  <verify>
Manual test:
1. Clear browser storage (DevTools > Application > Storage > Clear site data)
2. Load voter guide, enter address - observe network fetch of GeoJSON
3. Refresh page, enter another address - observe NO network fetch (cached)
4. Check IndexedDB in DevTools > Application > IndexedDB > voter-guide-cache
  </verify>
  <done>GeoJSON boundaries cached in IndexedDB, no re-fetch on page reload</done>
</task>

<task type="auto">
  <name>Task 3: Add localStorage persistence to dataLoader</name>
  <files>src/lib/dataLoader.ts</files>
  <action>
Modify `DataLoader.fetch()` in dataLoader.ts to use localStorage caching:

1. **Before network fetch, check localStorage**:
   ```typescript
   const cached = getJsonFromCache<unknown>(cacheKey);
   if (cached !== null) {
     this.cache.set(cacheKey, cached);
     return cached;
   }
   ```

2. **After successful network fetch, cache to localStorage**:
   ```typescript
   setJsonInCache(cacheKey, data);
   ```

3. **Add selective caching** - Only cache Tier 2 and Tier 3 data:
   - Tier 1 data (election-dates, statewide-races) changes more frequently - keep in-memory only
   - Tier 2 (candidates, county-races) - cache in localStorage
   - Tier 3 (judicial, school-board, etc.) - cache in localStorage
   - Add `persistable` property to DataLoaderOptions, default false for Tier 1

4. **Update clearCache()** to also clear localStorage caches:
   ```typescript
   clearCache() {
     this.cache.clear();
     this.pendingRequests.clear();
     // Clear localStorage caches for this loader
     ['candidates', 'congress-candidates', 'county-races', 'judicial', 'school', 'districts', 'measures']
       .forEach(key => localStorage.removeItem(`vg-cache-${key}`));
   }
   ```

5. **Handle localStorage errors gracefully** - Fall back to memory-only if storage fails
  </action>
  <verify>
Manual test:
1. Clear browser storage
2. Load voter guide, enter address - observe network fetch of JSON files
3. Check localStorage in DevTools > Application > Local Storage
4. Refresh page - observe NO network fetch for Tier 2/3 data (cached)
5. Run npm run build to ensure no SSR errors
  </verify>
  <done>JSON data files cached in localStorage with version tracking, SSR-safe implementation</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm test` passes all tests (including new cacheUtils tests)
- [ ] `npm run build` succeeds without SSR errors
- [ ] `npm run lint` passes
- [ ] GeoJSON boundaries load from IndexedDB cache on repeat visits (no network request)
- [ ] JSON data loads from localStorage cache on repeat visits (Tier 2/3 only)
- [ ] Cache clears correctly when CACHE_VERSION is incremented
- [ ] No console errors in private/incognito browsing mode
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Returning users see instant data loading (no network waterfall)
- Cache invalidation works when version is bumped
- No TypeScript errors
- SSR build completes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/09-performance-optimization/09-01-SUMMARY.md` using the summary template.

Include:
- Cache hit rates observed during testing
- Size of cached data (IndexedDB + localStorage)
- Any decisions made about what to cache vs not cache
- Commits produced
</output>
