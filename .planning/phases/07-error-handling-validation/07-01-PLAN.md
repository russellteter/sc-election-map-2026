---
phase: 07-error-handling-validation
plan: 01
type: execute
depends_on: []
files_modified:
  - src/lib/geocoding.ts
  - src/lib/addressValidation.ts
  - src/hooks/useAddressLookup.ts
  - src/components/VoterGuide/AddressAutocomplete.tsx
  - src/components/VoterGuide/ErrorDisplay.tsx
---

<objective>
Improve error messaging for failed lookups and invalid addresses with user-friendly feedback and recovery suggestions.

Purpose: Currently users receive generic errors when address lookups fail. This phase adds pre-flight validation, user-friendly error messages with actionable suggestions, and a dedicated error display component.

Output: Enhanced address validation with specific error types, a reusable ErrorDisplay component, and context-aware error messages with recovery suggestions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/CONCERNS.md
@.planning/phases/06-address-ux-improvements/06-01-SUMMARY.md

# Key files
@src/lib/geocoding.ts
@src/hooks/useAddressLookup.ts
@src/components/VoterGuide/AddressAutocomplete.tsx

**Tech stack available:** React 19, Next.js 16, TypeScript (strict mode)
**Established patterns:** SSR-safe localStorage, graceful error handling with fallbacks, glassmorphic UI

**Constraining decisions:**
- Phase 6: URL params take priority over localStorage
- Phase 4: Custom hooks manage data logic, components are presentational
- Component convention: Named exports for components, PascalCase.tsx files

**From CONCERNS.md:**
- "No Address Validation Feedback: Invalid addresses may return empty results with no user feedback"
- "Implementation complexity: Low (add validation messaging)"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create address validation module with specific error types</name>
  <files>src/lib/addressValidation.ts</files>
  <action>
Create a new address validation module with:

1. **ValidationResult type:**
```typescript
interface ValidationResult {
  isValid: boolean;
  errorType?: 'empty' | 'too_short' | 'missing_street' | 'po_box_warning' | 'zip_only' | 'city_only' | 'non_sc';
  message?: string;
  suggestion?: string;
}
```

2. **validateAddress function** that checks:
- Empty input → "Please enter your address"
- Too short (<5 chars) → "Please enter a complete street address"
- ZIP-only (existing check moved here) → "Please enter a full street address, not just a ZIP code"
- City-only (pattern: single word + optional ", SC") → "Please include your street address"
- Missing street number (starts with letter, no numbers) → "Please include your street number"
- PO Box detection → warning with "PO Box addresses may not accurately determine your voting district. Try your residential address."

3. **getErrorSuggestion function** that returns context-aware suggestions based on error type:
- 'too_short' → "Example: 123 Main Street, Columbia, SC 29201"
- 'zip_only' → "Try: 123 Main Street, [city], SC [your ZIP]"
- 'city_only' → "Try: [street number] [street name], [city], SC"

Follow existing module patterns: camelCase functions, detailed JSDoc, debug logging.
  </action>
  <verify>TypeScript compiles without errors: `npm run build`</verify>
  <done>addressValidation.ts exists with ValidationResult type, validateAddress function, and getErrorSuggestion function</done>
</task>

<task type="auto">
  <name>Task 2: Create reusable ErrorDisplay component with severity levels</name>
  <files>src/components/VoterGuide/ErrorDisplay.tsx, src/components/VoterGuide/index.ts</files>
  <action>
Create a dedicated error display component:

1. **Props interface:**
```typescript
interface ErrorDisplayProps {
  type: 'error' | 'warning' | 'info';
  message: string;
  suggestion?: string;
  recoveryAction?: {
    label: string;
    href?: string;
    onClick?: () => void;
  };
}
```

2. **Component features:**
- Different visual styles per type:
  - error: red background (var(--color-at-risk-bg)), red icon
  - warning: amber background, warning icon
  - info: purple background (var(--class-purple-bg)), info icon
- Message text prominently displayed
- Optional suggestion text in smaller/muted style below message
- Optional action button (link or onClick) styled appropriately
- Accessible: role="alert" for errors, role="status" for warnings/info
- animate-entrance class for smooth appearance

3. **Follow existing patterns:**
- Use glassmorphic design tokens from AddressAutocomplete error display
- Named export: `export function ErrorDisplay`
- Add to barrel export in index.ts

Replace inline error JSX in AddressAutocomplete with the new ErrorDisplay component (but keep logic in hook).
  </action>
  <verify>Component renders correctly in dev server: `npm run dev` and trigger an error</verify>
  <done>ErrorDisplay.tsx exists with three severity levels, exported from index.ts, used in AddressAutocomplete</done>
</task>

<task type="auto">
  <name>Task 3: Integrate validation into useAddressLookup hook with user-friendly messages</name>
  <files>src/hooks/useAddressLookup.ts, src/lib/geocoding.ts</files>
  <action>
Integrate the new validation module:

1. **In useAddressLookup.ts:**
- Import validateAddress from @/lib/addressValidation
- Add `errorType` to the return interface (type: 'error' | 'warning' | 'info' | null)
- Add `errorSuggestion` to the return interface
- In handleAddressSubmit, run validateAddress BEFORE any API call
- If validation fails:
  - Set appropriate error, errorType, and errorSuggestion
  - Return early (don't call geocodeAddress)
- For API errors, map them to appropriate errorType and add suggestions:
  - 'Address not found' → errorType: 'error', suggestion: "Check spelling or try a nearby address"
  - Network errors → errorType: 'error', suggestion: "Check your internet connection"
  - Non-SC address → errorType: 'error', suggestion: "This tool only works for South Carolina addresses"
  - Partial district match → errorType: 'warning' (found some but not all districts)

2. **In geocoding.ts:**
- Remove the ZIP-only check (moved to addressValidation.ts)
- Keep the actual geocoding logic unchanged
- Error messages should be technical; the hook maps them to user-friendly versions

3. **Update AddressAutocomplete.tsx:**
- Pass errorType and errorSuggestion to ErrorDisplay component
- Add manual lookup fallback link as recoveryAction when appropriate

Maintain backwards compatibility: existing `error` string still works, new fields are additive.
  </action>
  <verify>`npm run build` passes, error states display correctly in dev server with different input types</verify>
  <done>Pre-flight validation runs before API calls, error messages include suggestions, ErrorDisplay shows appropriate severity</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Empty address shows error with suggestion
- [ ] ZIP-only input shows error with format suggestion
- [ ] Too-short input shows error with example
- [ ] Invalid SC address shows error with manual lookup link
- [ ] All error types display with correct severity styling
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript or ESLint errors introduced
- Error messages are user-friendly and actionable
- ErrorDisplay component is reusable and accessible
- Validation runs before API calls to reduce unnecessary requests
</success_criteria>

<output>
After completion, create `.planning/phases/07-error-handling-validation/07-01-SUMMARY.md`:

# Phase 7 Plan 01: Error Handling & Validation Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

[Ready for Phase 8: Test Coverage]
</output>
