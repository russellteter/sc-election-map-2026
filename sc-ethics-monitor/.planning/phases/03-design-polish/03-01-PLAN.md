---
phase: 03-design-polish
plan: 01
type: execute
depends_on:
  - 01-01 (district data)
  - 01-02 (incumbent data)
  - 01-03 (geographic data)
  - 02-01 (validation lists, formulas)
sheets_modified:
  - Dashboard (new tab with KPIs)
  - Districts (enhanced formatting)
domain: python-excel
---

<objective>
Create a Dashboard summary tab with live KPIs and polish visual design across all tabs.

Purpose: Campaign staff need at-a-glance insights. A well-designed dashboard surfaces the most important metrics immediately.

Output: Complete Excel file with Dashboard tab, enhanced conditional formatting, and professional styling.
</objective>

<execution_context>
**Base File:** `sc-ethics-monitor/data/SC_Ethics_Districts_Enriched.xlsx` (from Phase 1+2)
**Output:** Same file, enhanced with Phase 3 features

**Dashboard KPIs:**
1. Total districts (170)
2. Districts by chamber (House: 124, Senate: 46)
3. Districts by party (R: 121, D: 48, Open: 1)
4. Districts by region (Upstate, Midlands, Lowcountry, Pee Dee)
5. Competitive districts (margin < 10%)
6. High-priority recruitment targets (score >= 7)
7. By term status (Open, First-term, Veteran, Long-serving)
8. By district type (Urban, Suburban, Rural, Mixed)

**Color Palette:**
- Democrat: #0066CC (Blue)
- Republican: #CC0000 (Red)
- Header background: #1a1a2e (Dark blue)
- Header text: #FFFFFF (White)
- High priority: #FFD700 (Gold)
- Medium priority: #87CEEB (Sky blue)
- Section background: #f0f0f0 (Light gray)
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dashboard tab structure</name>
  <tool>python-excel</tool>
  <action>
Create Dashboard worksheet with KPI layout.

**Implementation:**
```python
def create_dashboard_tab(wb, districts_data):
    """Create Dashboard tab with KPI summary."""
    ws = wb.create_sheet("Dashboard", 0)  # First position

    # Title
    ws.merge_cells('A1:H1')
    ws['A1'] = 'SC Ethics Monitor Dashboard'
    ws['A1'].font = Font(size=24, bold=True, color='FFFFFF')
    ws['A1'].fill = PatternFill(start_color='1a1a2e', end_color='1a1a2e', fill_type='solid')
    ws['A1'].alignment = Alignment(horizontal='center', vertical='center')
    ws.row_dimensions[1].height = 40

    # Subtitle
    ws['A2'] = f'Generated: {datetime.now().strftime("%Y-%m-%d %H:%M")}'
    ws['A2'].font = Font(italic=True, color='666666')

    # Calculate KPIs from data
    total = len(districts_data)
    house_count = sum(1 for d in districts_data if d['chamber'] == 'House')
    senate_count = sum(1 for d in districts_data if d['chamber'] == 'Senate')
    r_count = sum(1 for d in districts_data if d['incumbent_party'] == 'R')
    d_count = sum(1 for d in districts_data if d['incumbent_party'] == 'D')
    open_count = sum(1 for d in districts_data if d['term_status'] == 'Open')

    # Region counts
    region_counts = {}
    for d in districts_data:
        region = d['region']
        region_counts[region] = region_counts.get(region, 0) + 1

    # Competitive and high-priority counts
    competitive = sum(1 for d in districts_data
                      if isinstance(d.get('last_election_margin'), (int, float))
                      and d['last_election_margin'] < 10)
    high_priority = sum(1 for d in districts_data if d.get('composite_score', 0) >= 7)

    # Write KPI sections
    row = 4
    ws = write_kpi_section(ws, row, 'OVERVIEW', {
        'Total Districts': total,
        'House Districts': house_count,
        'Senate Districts': senate_count
    })

    row = 9
    ws = write_kpi_section(ws, row, 'BY PARTY', {
        'Republican (R)': r_count,
        'Democratic (D)': d_count,
        'Open Seats': open_count
    })

    row = 14
    ws = write_kpi_section(ws, row, 'BY REGION', region_counts)

    row = 20
    ws = write_kpi_section(ws, row, 'PRIORITIES', {
        'Competitive (< 10% margin)': competitive,
        'High Priority (score >= 7)': high_priority
    })

    # Set column widths
    ws.column_dimensions['A'].width = 30
    ws.column_dimensions['B'].width = 15
    ws.column_dimensions['D'].width = 30
    ws.column_dimensions['E'].width = 15

    return ws


def write_kpi_section(ws, start_row, title, kpis):
    """Write a KPI section with title and key-value pairs."""
    # Section header
    ws.merge_cells(f'A{start_row}:B{start_row}')
    ws[f'A{start_row}'] = title
    ws[f'A{start_row}'].font = Font(size=14, bold=True)
    ws[f'A{start_row}'].fill = PatternFill(start_color='f0f0f0', end_color='f0f0f0', fill_type='solid')

    # KPI rows
    row = start_row + 1
    for label, value in kpis.items():
        ws[f'A{row}'] = label
        ws[f'B{row}'] = value
        ws[f'B{row}'].font = Font(size=16, bold=True)
        ws[f'B{row}'].alignment = Alignment(horizontal='right')
        row += 1

    return ws
```
  </action>
  <verify>Dashboard tab appears first with all KPI sections</verify>
  <done>Dashboard tab created with KPI layout and values</done>
</task>

<task type="auto">
  <name>Task 2: Add conditional formatting to Districts tab</name>
  <tool>python-excel</tool>
  <action>
Apply color-coded conditional formatting rules.

**Implementation:**
```python
from openpyxl.formatting.rule import FormulaRule, ColorScaleRule

def apply_conditional_formatting(ws, row_count):
    """Apply conditional formatting to Districts tab."""

    # Party column (F) - blue for D, red for R
    ws.conditional_formatting.add(
        f'F2:F{row_count + 1}',
        FormulaRule(
            formula=['$F2="D"'],
            fill=PatternFill(start_color='CCE5FF', end_color='CCE5FF', fill_type='solid')
        )
    )
    ws.conditional_formatting.add(
        f'F2:F{row_count + 1}',
        FormulaRule(
            formula=['$F2="R"'],
            fill=PatternFill(start_color='FFCCCC', end_color='FFCCCC', fill_type='solid')
        )
    )

    # Composite score column (R) - color scale green to red
    ws.conditional_formatting.add(
        f'R2:R{row_count + 1}',
        ColorScaleRule(
            start_type='num', start_value=0, start_color='CCFFCC',
            mid_type='num', mid_value=5, mid_color='FFFFCC',
            end_type='num', end_value=10, end_color='FFCCCC'
        )
    )

    # Term status column (O) - highlight Open seats
    ws.conditional_formatting.add(
        f'O2:O{row_count + 1}',
        FormulaRule(
            formula=['$O2="Open"'],
            fill=PatternFill(start_color='FFD700', end_color='FFD700', fill_type='solid'),
            font=Font(bold=True)
        )
    )
    ws.conditional_formatting.add(
        f'O2:O{row_count + 1}',
        FormulaRule(
            formula=['$O2="First-term"'],
            fill=PatternFill(start_color='87CEEB', end_color='87CEEB', fill_type='solid')
        )
    )

    # Election margin column (M) - highlight competitive
    ws.conditional_formatting.add(
        f'M2:M{row_count + 1}',
        FormulaRule(
            formula=['AND(ISNUMBER($M2), $M2<5)'],
            fill=PatternFill(start_color='FFCCCC', end_color='FFCCCC', fill_type='solid'),
            font=Font(bold=True)
        )
    )
    ws.conditional_formatting.add(
        f'M2:M{row_count + 1}',
        FormulaRule(
            formula=['AND(ISNUMBER($M2), $M2<10)'],
            fill=PatternFill(start_color='FFFFCC', end_color='FFFFCC', fill_type='solid')
        )
    )
```
  </action>
  <verify>Party column shows blue/red, scores show gradient, competitive races highlighted</verify>
  <done>Conditional formatting applied to key columns</done>
</task>

<task type="auto">
  <name>Task 3: Set tab colors and order</name>
  <tool>python-excel</tool>
  <action>
Configure tab colors for visual organization.

**Tab order and colors:**
1. Dashboard - Blue (#0066CC)
2. Districts - Green (#00AA00)
3. Lists - Gray (#666666) - hidden

**Implementation:**
```python
def set_tab_styling(wb):
    """Set tab colors and visibility."""
    # Tab colors
    if 'Dashboard' in wb.sheetnames:
        wb['Dashboard'].sheet_properties.tabColor = '0066CC'

    if 'Districts' in wb.sheetnames:
        wb['Districts'].sheet_properties.tabColor = '00AA00'

    if 'Lists' in wb.sheetnames:
        wb['Lists'].sheet_properties.tabColor = '666666'
        wb['Lists'].sheet_state = 'hidden'  # Hide Lists tab
```
  </action>
  <verify>Dashboard tab is blue, Districts is green, Lists is hidden</verify>
  <done>Tab colors and visibility configured</done>
</task>

<task type="auto">
  <name>Task 4: Add print settings</name>
  <tool>python-excel</tool>
  <action>
Configure print settings for professional output.

**Implementation:**
```python
from openpyxl.worksheet.page import PageMargins

def set_print_settings(ws, title, landscape=True):
    """Configure print settings for a worksheet."""
    # Page setup
    ws.page_setup.orientation = 'landscape' if landscape else 'portrait'
    ws.page_setup.fitToPage = True
    ws.page_setup.fitToWidth = 1
    ws.page_setup.fitToHeight = 0  # As many pages as needed

    # Margins
    ws.page_margins = PageMargins(
        left=0.5, right=0.5, top=0.75, bottom=0.75,
        header=0.3, footer=0.3
    )

    # Header/footer
    ws.oddHeader.center.text = title
    ws.oddFooter.center.text = 'Page &P of &N'
    ws.oddFooter.right.text = '&D'  # Date

    # Repeat row 1 on each page
    ws.print_title_rows = '1:1'
```
  </action>
  <verify>Print preview shows landscape with headers on each page</verify>
  <done>Print settings configured for all tabs</done>
</task>

<task type="auto">
  <name>Task 5: Final polish and freeze panes</name>
  <tool>python-excel</tool>
  <action>
Apply final polish: freeze panes, column widths, row heights.

**Implementation:**
```python
def apply_final_polish(ws):
    """Apply final polish to worksheet."""
    # Freeze first row (header)
    ws.freeze_panes = 'A2'

    # Auto-filter on header row
    ws.auto_filter.ref = ws.dimensions

    # Ensure consistent column widths
    column_widths = {
        'A': 18,  # district_id
        'B': 22,  # district_name
        'C': 10,  # chamber
        'D': 8,   # district_number
        'E': 25,  # incumbent_name
        'F': 8,   # incumbent_party
        'G': 12,  # incumbent_since
        'H': 12,  # next_election
        'I': 15,  # primary_county
        'J': 30,  # all_counties
        'K': 12,  # region
        'L': 10,  # terms_served
        'M': 18,  # last_election_margin
        'N': 18,  # last_election_votes
        'O': 14,  # term_status
        'P': 12,  # district_type
        'Q': 18,  # estimated_population
        'R': 14,  # composite_score
    }

    for col, width in column_widths.items():
        ws.column_dimensions[col].width = width
```
  </action>
  <verify>Panes frozen, filters enabled, columns properly sized</verify>
  <done>Final polish applied to all worksheets</done>
</task>

<task type="auto">
  <name>Task 6: Update generate_enriched_excel.py with Phase 3</name>
  <tool>python</tool>
  <action>
Integrate all Phase 3 functions into the main Excel generation script.

**Script update:**
1. Import all required openpyxl modules
2. Call create_dashboard_tab() with calculated KPIs
3. Call apply_conditional_formatting() on Districts
4. Call set_tab_styling() for colors and visibility
5. Call set_print_settings() for each tab
6. Call apply_final_polish() for freeze panes and filters
  </action>
  <verify>Script runs without errors, generates complete file</verify>
  <done>Excel generation script complete with all Phase 1-3 features</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Dashboard tab shows all KPIs correctly
- [ ] Conditional formatting highlights priorities
- [ ] Tab colors are set (blue Dashboard, green Districts)
- [ ] Lists tab is hidden
- [ ] Freeze panes work on Districts tab
- [ ] Auto-filter enabled
- [ ] Print settings configured
</verification>

<success_criteria>
- Dashboard provides at-a-glance campaign insights
- Visual design is professional and consistent
- Excel file is ready for Google Sheets import
- All Phase 1-3 features integrated
</success_criteria>

<output>
After completion, create `.planning/phases/03-design-polish/03-01-SUMMARY.md` with:
- Dashboard KPIs displayed
- Conditional formatting rules applied
- Tab styling configuration
- Final file details
</output>
