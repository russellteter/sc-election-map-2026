---
phase: 02-usability-improvements
plan: 01
type: execute
depends_on:
  - 01-01 (county data needed)
  - 01-02 (incumbent data needed)
  - 01-03 (geographic data needed)
sheets_modified:
  - Districts (add validation, formulas)
  - Lists (new tab with validation values)
domain: python-excel
---

<objective>
Add data validation lists, formula columns, and a Lists reference tab to the Excel file.

Purpose: Data validation prevents invalid entries. A Lists tab provides reference values for dropdowns. Formula columns enable dynamic calculations that carry over to Google Sheets.

Output: Enhanced Excel file with validation rules and formula-ready structure.
</objective>

<execution_context>
**Base File:** `sc-ethics-monitor/data/SC_Ethics_Districts_Enriched.xlsx` (from Phase 1)
**Output:** Same file, enhanced with Phase 2 features

**Validation Lists to Create:**
| List Name | Values |
|-----------|--------|
| Parties | D, R, I, O |
| Confidence | HIGH, MEDIUM, LOW, UNKNOWN |
| Regions | Upstate, Midlands, Lowcountry, Pee Dee |
| Priorities | High-D-Recruit, Open-Seat, Monitor, Low |
| Statuses | Pending, In-Progress, Resolved |
| Chambers | House, Senate |
| TermStatus | Open, First-term, Veteran, Long-serving |
| DistrictType | Urban, Suburban, Rural, Mixed |

**Data Validation to Apply:**
- incumbent_party column: dropdown from Parties list
- region column: dropdown from Regions list
- term_status column: dropdown from TermStatus list
- district_type column: dropdown from DistrictType list
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Add Lists tab with validation values</name>
  <tool>python-excel</tool>
  <action>
Update `generate_enriched_excel.py` to create a "Lists" worksheet containing validation reference values.

**Implementation:**
```python
def create_lists_tab(wb):
    """Create Lists tab with validation reference values."""
    ws = wb.create_sheet("Lists")

    # Define lists
    validation_lists = {
        'Parties': ['D', 'R', 'I', 'O'],
        'Confidence': ['HIGH', 'MEDIUM', 'LOW', 'UNKNOWN'],
        'Regions': ['Upstate', 'Midlands', 'Lowcountry', 'Pee Dee'],
        'Priorities': ['High-D-Recruit', 'Open-Seat', 'Monitor', 'Low'],
        'Statuses': ['Pending', 'In-Progress', 'Resolved'],
        'Chambers': ['House', 'Senate'],
        'TermStatus': ['Open', 'First-term', 'Veteran', 'Long-serving'],
        'DistrictType': ['Urban', 'Suburban', 'Rural', 'Mixed']
    }

    # Write headers in row 1, values below
    for col_idx, (list_name, values) in enumerate(validation_lists.items(), 1):
        ws.cell(row=1, column=col_idx, value=list_name)
        for row_idx, value in enumerate(values, 2):
            ws.cell(row=row_idx, column=col_idx, value=value)

    # Style headers
    header_fill = PatternFill(start_color='1a1a2e', end_color='1a1a2e', fill_type='solid')
    header_font = Font(bold=True, color='FFFFFF')
    for cell in ws[1]:
        cell.fill = header_fill
        cell.font = header_font

    # Set column widths
    for col in ws.columns:
        ws.column_dimensions[col[0].column_letter].width = 18

    return ws
```
  </action>
  <verify>Lists tab contains 8 columns with validation values</verify>
  <done>Lists tab created with all validation reference values</done>
</task>

<task type="auto">
  <name>Task 2: Apply data validation dropdowns to Districts tab</name>
  <tool>python-excel</tool>
  <action>
Add data validation rules to key columns using the Lists tab as reference.

**Implementation:**
```python
from openpyxl.worksheet.datavalidation import DataValidation

def apply_data_validation(ws_districts, row_count):
    """Apply dropdown validation to Districts columns."""

    # Party validation (column F - incumbent_party)
    party_dv = DataValidation(
        type="list",
        formula1="Lists!$A$2:$A$5",
        allow_blank=True,
        showDropDown=False
    )
    party_dv.error = "Please select D, R, I, or O"
    party_dv.errorTitle = "Invalid Party"
    ws_districts.add_data_validation(party_dv)
    party_dv.add(f'F2:F{row_count + 1}')

    # Region validation (column K)
    region_dv = DataValidation(
        type="list",
        formula1="Lists!$C$2:$C$5",
        allow_blank=False
    )
    ws_districts.add_data_validation(region_dv)
    region_dv.add(f'K2:K{row_count + 1}')

    # Term status validation (column O)
    status_dv = DataValidation(
        type="list",
        formula1="Lists!$G$2:$G$5",
        allow_blank=False
    )
    ws_districts.add_data_validation(status_dv)
    status_dv.add(f'O2:O{row_count + 1}')

    # District type validation (column P)
    type_dv = DataValidation(
        type="list",
        formula1="Lists!$H$2:$H$5",
        allow_blank=False
    )
    ws_districts.add_data_validation(type_dv)
    type_dv.add(f'P2:P{row_count + 1}')
```
  </action>
  <verify>Dropdown arrows appear in validated columns in Excel</verify>
  <done>Data validation applied to party, region, term_status, and district_type columns</done>
</task>

<task type="auto">
  <name>Task 3: Add formula-ready columns for Race Analysis</name>
  <tool>python-excel</tool>
  <action>
Add columns that will support Race Analysis calculations when imported to Google Sheets.

**New columns to add (S-V):**
| Column | Name | Purpose |
|--------|------|---------|
| S | is_competitive | TRUE if margin < 10% |
| T | recruitment_priority | Based on term_status, margin, party |
| U | needs_d_candidate | TRUE if R incumbent and no D filed |
| V | score_category | High/Medium/Low based on composite_score |

**Implementation:**
```python
def add_analysis_columns(ws, row_count):
    """Add calculated analysis columns."""

    # Add headers
    ws['S1'] = 'is_competitive'
    ws['T1'] = 'recruitment_priority'
    ws['U1'] = 'needs_d_candidate'
    ws['V1'] = 'score_category'

    for row in range(2, row_count + 2):
        # is_competitive: TRUE if margin < 10%
        margin_cell = f'M{row}'
        ws[f'S{row}'] = f'=IF(ISNUMBER({margin_cell}), {margin_cell}<10, FALSE)'

        # recruitment_priority: High-D-Recruit if R incumbent + competitive
        ws[f'T{row}'] = f'=IF(AND(F{row}="R", S{row}=TRUE), "High-D-Recruit", IF(O{row}="Open", "Open-Seat", IF(S{row}=TRUE, "Monitor", "Low")))'

        # needs_d_candidate: TRUE if R incumbent
        ws[f'U{row}'] = f'=IF(F{row}="R", TRUE, FALSE)'

        # score_category based on composite_score
        ws[f'V{row}'] = f'=IF(R{row}>=7, "High", IF(R{row}>=4, "Medium", "Low"))'
```
  </action>
  <verify>Formula columns calculate correctly in Excel</verify>
  <done>Analysis formula columns added to Districts tab</done>
</task>

<task type="auto">
  <name>Task 4: Update generate_enriched_excel.py with Phase 2</name>
  <tool>python</tool>
  <action>
Integrate all Phase 2 functions into the main Excel generation script.

**Script update:**
1. Import DataValidation from openpyxl
2. Call create_lists_tab() after Districts sheet
3. Call apply_data_validation() on Districts sheet
4. Call add_analysis_columns() on Districts sheet
5. Set Lists tab as hidden (sheet_state = 'hidden')
  </action>
  <verify>Script runs without errors</verify>
  <done>Excel generation script enhanced with Phase 2 features</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Lists tab exists with 8 validation columns
- [ ] Dropdowns work in party, region, term_status, district_type columns
- [ ] Formula columns S-V calculate correctly
- [ ] Excel file opens without errors
- [ ] Validation formulas reference Lists tab correctly
</verification>

<success_criteria>
- All validation lists defined in Lists tab
- Key columns have dropdown validation
- Formula columns ready for Race Analysis
- No Excel errors on file open
</success_criteria>

<output>
After completion, create `.planning/phases/02-usability-improvements/02-01-SUMMARY.md` with:
- Validation lists created
- Validation rules applied
- Formula columns added
- Any issues encountered
</output>
