---
phase: 04-candidate-discovery
plan: 02
type: standard
---

# Plan 04-02: Ballotpedia Source

<objective>
Implement the Ballotpedia candidate discovery source using Firecrawl for web scraping.

Purpose: Ballotpedia is the most comprehensive public source for candidate data. This source will scrape all 170 SC legislative district pages.

Output: Working BallotpediaSource class that can discover candidates from all SC House and Senate districts.
</objective>

<context>
@.planning/phases/04-candidate-discovery/DESIGN.md
@src/candidate_discovery/sources/base.py
@src/candidate_discovery/rate_limiter.py
@src/config.py
</context>

<tasks>

<task type="auto" id="1">
  <name>Implement BallotpediaSource class</name>
  <action>
    Create `src/candidate_discovery/sources/ballotpedia.py` with:
    - BallotpediaSource(CandidateSource) class
    - source_name = "ballotpedia"
    - source_priority = 2
    - __init__ accepting firecrawl_api_key and optional rate_limit
    - _build_url(chamber, district_num) generating proper Ballotpedia URLs
    - Uses Firecrawl MCP tool for scraping (firecrawl_scrape)
  </action>
  <verify>Class instantiates without error</verify>
  <done>BallotpediaSource class is defined with proper structure</done>
</task>

<task type="auto" id="2">
  <name>Implement district page scraping</name>
  <action>
    Add to BallotpediaSource:
    - async _scrape_district_page(url, district_id) method
    - Uses Firecrawl to get markdown content
    - Handles errors gracefully (returns empty list on failure)
    - Calls _parse_candidates on successful scrape
  </action>
  <verify>Method correctly fetches and returns markdown from a test URL</verify>
  <done>District page scraping works with Firecrawl</done>
</task>

<task type="auto" id="3">
  <name>Implement candidate parsing from markdown</name>
  <action>
    Add to BallotpediaSource:
    - _parse_candidates(markdown, district_id, source_url) method
    - Detects 2026 election section
    - Parses candidate pattern: **Name** (Party)
    - Handles Republican/Democratic/Independent party text
    - Detects incumbent status
    - Returns list of DiscoveredCandidate objects
    - _normalize_party(party_text) helper
  </action>
  <verify>Parsing correctly extracts candidates from sample Ballotpedia markdown</verify>
  <done>Candidate parsing extracts name, party, incumbent status</done>
</task>

<task type="auto" id="4">
  <name>Implement full discovery method</name>
  <action>
    Add to BallotpediaSource:
    - async discover_candidates(chambers=["house", "senate"]) method
    - Iterates through all 170 districts (124 House + 46 Senate)
    - Respects rate limiting between requests
    - Collects candidates from all pages
    - Logs progress during scraping
    - Returns aggregated list of DiscoveredCandidate
  </action>
  <verify>Method runs without error on a subset of districts</verify>
  <done>Full discovery iterates all districts with rate limiting</done>
</task>

<task type="auto" id="5">
  <name>Implement extract_district_candidates</name>
  <action>
    Add to BallotpediaSource:
    - extract_district_candidates(district_id) method
    - Parses district_id to get chamber and number
    - Builds URL and scrapes single district
    - Returns candidates for that district only
  </action>
  <verify>Can fetch candidates for a specific district like "SC-House-042"</verify>
  <done>Single district extraction works correctly</done>
</task>

<task type="auto" id="6">
  <name>Create mock Ballotpedia pages for testing</name>
  <action>
    Create `tests/fixtures/ballotpedia_sample.md` with:
    - Sample Ballotpedia page markdown for SC House District 42
    - 2026 election section with candidates
    - Mix of incumbent and challenger
    - Both party primaries

    Create additional test fixtures:
    - ballotpedia_no_election.md (no 2026 section)
    - ballotpedia_single_candidate.md (uncontested race)
  </action>
  <verify>Fixture files exist and contain valid test data</verify>
  <done>Test fixtures created for Ballotpedia parsing</done>
</task>

<task type="auto" id="7">
  <name>Create unit tests for BallotpediaSource</name>
  <action>
    Create `tests/test_ballotpedia_source.py` with tests for:
    - URL building for House and Senate districts
    - Candidate parsing from markdown fixtures
    - Party normalization (Democrat→D, Republican→R)
    - Incumbent detection
    - Empty/no-election page handling
    - Error handling for failed scrapes
  </action>
  <verify>pytest tests/test_ballotpedia_source.py -v</verify>
  <done>All Ballotpedia source tests pass</done>
</task>

</tasks>

<verification>
- [ ] BallotpediaSource class implements CandidateSource interface
- [ ] URL building generates correct Ballotpedia URLs
- [ ] Candidate parsing extracts name, party, incumbent status
- [ ] Rate limiting is respected between requests
- [ ] Full discovery can iterate all 170 districts
- [ ] Single district extraction works
- [ ] All unit tests pass
</verification>

<success_criteria>
- BallotpediaSource can scrape a real Ballotpedia page and extract candidates
- Parsing handles various Ballotpedia page formats
- Rate limiting prevents API throttling
- Test coverage for all parsing scenarios
</success_criteria>

<output>
Create 04-02-SUMMARY.md documenting:
- BallotpediaSource implementation details
- Parsing patterns that work for Ballotpedia
- Any Ballotpedia page format variations discovered
- Test coverage summary
</output>
