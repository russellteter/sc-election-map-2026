---
phase: 04-candidate-discovery
plan: 04
type: standard
---

# Plan 04-04: Aggregator and Integration

<objective>
Implement the CandidateAggregator to merge data from all sources and integrate with Google Sheets.

Purpose: Combine candidates from multiple sources, resolve conflicts, and sync to the existing Google Sheets system.

Output: Working aggregator and sheets integration that populates discovered candidates.
</objective>

<context>
@.planning/phases/04-candidate-discovery/DESIGN.md
@src/candidate_discovery/sources/base.py
@src/candidate_discovery/deduplicator.py
@src/sheets_sync.py
@src/monitor.py
</context>

<tasks>

<task type="auto" id="1">
  <name>Implement AggregationResult dataclass</name>
  <action>
    Create `src/candidate_discovery/aggregator.py` with:
    - AggregationResult dataclass (candidates, source_stats, conflicts, total_raw, total_deduplicated)
    - SourceResult dataclass (success, candidates, error, partial_coverage)
  </action>
  <verify>Dataclasses are importable and instantiable</verify>
  <done>Aggregation result structures are defined</done>
</task>

<task type="auto" id="2">
  <name>Implement CandidateAggregator class</name>
  <action>
    Add to aggregator.py:
    - CandidateAggregator class
    - __init__(sources: list[CandidateSource])
    - Sorts sources by priority
    - Creates CandidateDeduplicator instance
  </action>
  <verify>Aggregator instantiates with source list</verify>
  <done>CandidateAggregator class structure is complete</done>
</task>

<task type="auto" id="3">
  <name>Implement aggregate_all method</name>
  <action>
    Add to CandidateAggregator:
    - async aggregate_all() method
    - Iterates through all sources
    - Collects candidates with error handling
    - Calls deduplicator on combined results
    - Finds conflicts using _find_conflicts()
    - Returns AggregationResult with stats
    - Logs progress during aggregation
  </action>
  <verify>Method aggregates from multiple mock sources</verify>
  <done>Aggregation combines sources and deduplicates</done>
</task>

<task type="auto" id="4">
  <name>Implement conflict detection</name>
  <action>
    Add to CandidateAggregator:
    - _find_conflicts(candidates) method
    - Identifies candidates with differing party across sources
    - Creates ConflictRecord for each conflict
    - Records resolution and resolution source
  </action>
  <verify>Conflict detection finds party disagreements</verify>
  <done>Conflicts are detected and recorded properly</done>
</task>

<task type="auto" id="5">
  <name>Implement DiscoverySheetIntegration class</name>
  <action>
    Create `src/candidate_discovery/sheets_integration.py` with:
    - DiscoverySheetIntegration class
    - __init__(sheets_sync: SheetsSync)
    - _build_name_index(sheet_state) for matching
    - _find_existing(candidate, sheet_state, name_index)
    - _names_fuzzy_match() for approximate matching
  </action>
  <verify>Integration class instantiates with sheets_sync</verify>
  <done>Sheets integration class structure is complete</done>
</task>

<task type="auto" id="6">
  <name>Implement sync_discovered_candidates</name>
  <action>
    Add to DiscoverySheetIntegration:
    - sync_discovered_candidates(candidates) method
    - Reads current sheet state
    - Matches candidates to existing records
    - Updates existing records with new source data
    - Adds new candidates as placeholder records
    - Returns SyncResult with added and updated lists
    - Respects party_locked flags
  </action>
  <verify>Sync correctly updates sheet with new candidates</verify>
  <done>Sync adds new and updates existing candidates</done>
</task>

<task type="auto" id="7">
  <name>Integrate discovery into monitor.py</name>
  <action>
    Update `src/monitor.py`:
    - Add _should_run_discovery() method (weekly or forced)
    - Add _run_candidate_discovery() method
    - Add discovery step in run_daily_monitor() after existing steps
    - Trigger party detection for candidates without party
    - Log discovery stats
  </action>
  <verify>Monitor runs discovery step when appropriate</verify>
  <done>Discovery is integrated into monitor workflow</done>
</task>

<task type="auto" id="8">
  <name>Create integration tests</name>
  <action>
    Create `tests/test_aggregator.py` with tests for:
    - Aggregation from multiple sources
    - Deduplication across sources
    - Conflict detection and resolution
    - Source priority ordering

    Create `tests/test_sheets_integration.py` with tests for:
    - Finding existing candidates
    - Adding new candidates
    - Updating existing records
    - Respecting party_locked
  </action>
  <verify>pytest tests/test_aggregator.py tests/test_sheets_integration.py -v</verify>
  <done>All aggregator and integration tests pass</done>
</task>

</tasks>

<verification>
- [ ] CandidateAggregator combines data from all sources
- [ ] Deduplication removes duplicates across sources
- [ ] Conflicts are detected and recorded
- [ ] Sheets integration syncs candidates correctly
- [ ] Monitor runs discovery on schedule
- [ ] All integration tests pass
</verification>

<success_criteria>
- Aggregator successfully merges candidates from all sources
- Conflicts are properly detected and resolved by priority
- Sheets integration updates Google Sheets without data loss
- Discovery runs as part of monitor workflow
</success_criteria>

<output>
Create 04-04-SUMMARY.md documenting:
- Aggregator implementation details
- Sheets integration approach
- Monitor integration changes
- Conflict resolution strategy
- Test coverage summary
</output>
