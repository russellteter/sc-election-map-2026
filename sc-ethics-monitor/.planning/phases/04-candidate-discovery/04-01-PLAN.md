---
phase: 04-candidate-discovery
plan: 01
type: standard
---

# Plan 04-01: Core Infrastructure

<objective>
Build the foundational infrastructure for the candidate discovery pipeline.

Purpose: Establish base classes, data structures, and deduplication logic that all source scrapers will use.

Output: Working candidate_discovery module with core infrastructure ready for source implementations.
</objective>

<context>
@.planning/phases/04-candidate-discovery/DESIGN.md
@src/config.py
@src/monitor.py
@requirements.txt
</context>

<tasks>

<task type="auto" id="1">
  <name>Create module structure</name>
  <action>
    Create the candidate_discovery module directory structure:
    - `src/candidate_discovery/__init__.py`
    - `src/candidate_discovery/sources/__init__.py`
  </action>
  <verify>Both __init__.py files exist and are importable</verify>
  <done>Module structure exists with proper __init__.py files</done>
</task>

<task type="auto" id="2">
  <name>Implement DiscoveredCandidate dataclass</name>
  <action>
    Create `src/candidate_discovery/sources/base.py` with:
    - DiscoveredCandidate dataclass (name, district_id, party, party_confidence, source, source_url, filing_status, discovered_date, incumbent, additional_data)
    - MergedCandidate dataclass (extends with sources list, source_urls, source_records, primary_source)
    - ConflictRecord dataclass for tracking conflicts
    - Abstract CandidateSource base class with:
      - source_name property
      - source_priority property
      - discover_candidates() async method
      - extract_district_candidates() method
  </action>
  <verify>python -c "from candidate_discovery.sources.base import DiscoveredCandidate, CandidateSource"</verify>
  <done>Base classes and dataclasses are defined and importable</done>
</task>

<task type="auto" id="3">
  <name>Implement CandidateDeduplicator</name>
  <action>
    Create `src/candidate_discovery/deduplicator.py` with:
    - CandidateDeduplicator class with:
      - SIMILARITY_THRESHOLD = 0.85
      - deduplicate() method that groups by district and clusters by name
      - _cluster_by_name() for fuzzy grouping
      - _names_match() using normalization and LCS similarity
      - _normalize_name() removing suffixes, middle initials
      - _calculate_similarity() using longest common subsequence
      - _merge_cluster() to combine duplicate records
      - _get_source_priority() for conflict resolution
      - _best_filing_status() to pick most advanced status
  </action>
  <verify>Run unit tests for deduplicator - test name normalization and similarity</verify>
  <done>Deduplicator handles common name variations correctly</done>
</task>

<task type="auto" id="4">
  <name>Implement RateLimiter utility</name>
  <action>
    Create `src/candidate_discovery/rate_limiter.py` with:
    - RateLimiter class with:
      - __init__(requests_per_minute: int = 30)
      - async wait() method that respects rate limit
      - Tracks last_request time and calculates required delays
  </action>
  <verify>Test rate limiter with rapid calls - should throttle appropriately</verify>
  <done>Rate limiter throttles requests to configured RPM</done>
</task>

<task type="auto" id="5">
  <name>Add discovery configuration</name>
  <action>
    Update `src/config.py` to add:
    - DISCOVERY_ENABLED (bool from env)
    - DISCOVERY_FREQUENCY (weekly/daily/manual from env)
    - DISCOVERY_SOURCES (list from comma-separated env)
    - NAME_SIMILARITY_THRESHOLD (float from env, default 0.85)
    - FIRECRAWL_RPM (int from env, default 30)
  </action>
  <verify>python -c "from config import DISCOVERY_ENABLED, DISCOVERY_SOURCES"</verify>
  <done>Discovery configuration is available from config module</done>
</task>

<task type="auto" id="6">
  <name>Add dependencies to requirements.txt</name>
  <action>
    Add to requirements.txt:
    - python-Levenshtein>=0.25.0 (fast fuzzy matching)
    - tenacity>=8.2.0 (retry logic)
    Ensure existing dependencies remain intact
  </action>
  <verify>pip install -r requirements.txt succeeds</verify>
  <done>New dependencies are installable</done>
</task>

<task type="auto" id="7">
  <name>Create unit tests for core infrastructure</name>
  <action>
    Create `tests/test_deduplicator.py` with tests for:
    - Name normalization (Jr., middle initials, case)
    - Similarity calculation (exact match, similar names, different names)
    - Clustering (same person different sources, different people)
    - Merge logic (priority ordering, filing status selection)
  </action>
  <verify>pytest tests/test_deduplicator.py -v</verify>
  <done>All deduplicator tests pass</done>
</task>

</tasks>

<verification>
- [ ] Module structure exists: `src/candidate_discovery/__init__.py`, `sources/__init__.py`
- [ ] Base classes importable: DiscoveredCandidate, MergedCandidate, CandidateSource
- [ ] Deduplicator handles name variations correctly
- [ ] Rate limiter throttles appropriately
- [ ] Config has discovery settings
- [ ] Dependencies install successfully
- [ ] Unit tests pass
</verification>

<success_criteria>
- All 7 tasks complete with passing tests
- Core infrastructure ready for source implementations
- No import errors when loading candidate_discovery module
</success_criteria>

<output>
Create 04-01-SUMMARY.md documenting:
- Module structure created
- Classes and dataclasses implemented
- Test coverage for deduplicator
- Any deviations from design
</output>
