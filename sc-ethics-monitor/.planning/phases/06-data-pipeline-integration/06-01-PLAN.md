---
phase: 06-data-pipeline-integration
plan: 01
type: execute
depends_on: []
files_modified: [sc-ethics-monitor/src/sheets_sync.py]
---

<objective>
Fix final_party formula and Race Analysis aggregation to correctly display candidate counts.

Purpose: Race Analysis currently shows ALL ZEROS because it reads from empty `final_party` column instead of populated `detected_party`. This makes the entire dashboard useless for campaign planning.

Output: Race Analysis displays accurate candidate counts (5 D, 2 R) using fallback logic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@sc-ethics-monitor/.planning/PROJECT.md
@sc-ethics-monitor/.planning/ROADMAP.md
@sc-ethics-monitor/.planning/STATE.md
@sc-ethics-monitor/.planning/phases/05-data-remediation/05-05-SUMMARY.md
@sc-ethics-monitor/src/sheets_sync.py
@sc-ethics-monitor/src/config.py

**Current State:**
- Candidates tab has 28 candidates
- `detected_party` column (G) has 7 parties detected (5 D, 2 R)
- `final_party` column (L) is EMPTY (never populated with formula)
- Race Analysis reads `final_party` â†’ shows ALL ZEROS

**Required Fix:**
- `final_party` should use formula: `=IF(K<>"",K,G)` (manual override K, fallback to detected G)
- Or: Update Race Analysis to read `detected_party` as fallback when `final_party` is empty
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add final_party fallback logic to Race Analysis update</name>
  <files>sc-ethics-monitor/src/sheets_sync.py</files>
  <action>
In the `update_race_analysis` method of SheetsSync class:

1. Find where candidates are counted by party for race analysis
2. Modify the party retrieval logic to check `final_party` first, then fall back to `detected_party` if empty
3. The logic should be: `party = row.get('final_party') or row.get('detected_party') or 'UNKNOWN'`

This ensures Race Analysis displays correct counts even when manual overrides haven't been entered.
  </action>
  <verify>
Run: `cd sc-ethics-monitor && python -c "from src.sheets_sync import SheetsSync; s=SheetsSync(); print('Import OK')"`
Verify no syntax errors in sheets_sync.py
  </verify>
  <done>
sheets_sync.py modified to use detected_party fallback in race analysis counting
  </done>
</task>

<task type="auto">
  <name>Task 2: Add apply_final_party_formula method</name>
  <files>sc-ethics-monitor/src/sheets_sync.py</files>
  <action>
Add a new method `apply_final_party_formula()` to SheetsSync class that:

1. Reads the Candidates tab
2. For each row, sets column L (final_party) to:
   - Column K (party_override) if not empty
   - Otherwise column G (detected_party)
3. This can be done by writing values directly (faster than formulas for gspread)
4. Add a log message showing how many rows updated

Call signature: `def apply_final_party_formula(self) -> int:` (returns count of updated rows)
  </action>
  <verify>
Run: `cd sc-ethics-monitor && python -c "from src.sheets_sync import SheetsSync; print(hasattr(SheetsSync, 'apply_final_party_formula'))"`
Should print: True
  </verify>
  <done>
New method apply_final_party_formula exists and can be called
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Race Analysis shows correct counts</name>
  <files>sc-ethics-monitor/src/sheets_sync.py</files>
  <action>
Create a test/verification script at end of sheets_sync.py that can be run standalone:

```python
if __name__ == "__main__":
    import sys
    sync = SheetsSync()
    if sync.connect():
        # Apply formula
        updated = sync.apply_final_party_formula()
        print(f"Updated {updated} candidate final_party values")

        # Force race analysis recalculation
        # (use existing method or trigger update)
        print("Race Analysis should now show correct counts")
        print("Check: https://docs.google.com/spreadsheets/d/17j_KFZFUw-ESBQlKlIccUMpGCFq_XdeL6WYph7zkxQo/edit")
    else:
        print("Failed to connect")
        sys.exit(1)
```

Run it to verify the fix works.
  </action>
  <verify>
Run: `cd sc-ethics-monitor && python -m src.sheets_sync`
Should output: "Updated X candidate final_party values"
Then manually check Google Sheet Race Analysis tab shows non-zero counts
  </verify>
  <done>
Race Analysis displays: 5 D candidates, 2 R candidates (not zeros)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `sheets_sync.py` has fallback logic for detected_party
- [ ] `apply_final_party_formula()` method exists and works
- [ ] Running `python -m src.sheets_sync` populates final_party
- [ ] Race Analysis tab shows non-zero candidate counts
</verification>

<success_criteria>
- Race Analysis shows 5 D, 2 R (not all zeros)
- final_party column populated for all 28 candidates
- Fallback logic ensures future candidates also display correctly
</success_criteria>

<output>
After completion, create `sc-ethics-monitor/.planning/phases/06-data-pipeline-integration/06-01-SUMMARY.md`
</output>
