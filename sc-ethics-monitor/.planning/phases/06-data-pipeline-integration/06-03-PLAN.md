---
phase: 06-data-pipeline-integration
plan: 03
type: execute
depends_on: ["06-02"]
files_modified: [sc-ethics-monitor/scripts/export_to_webapp.py, public/data/candidates.json]
---

<objective>
Create export script that generates candidates.json for the web app from Google Sheets.

Purpose: The Google Sheet (Source of Truth) is disconnected from the public website. An export script will bridge this gap, making the Sheet the authoritative data source.

Output: `scripts/export_to_webapp.py` generates `public/data/candidates.json` matching existing format.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@sc-ethics-monitor/.planning/PROJECT.md
@sc-ethics-monitor/.planning/ROADMAP.md
@sc-ethics-monitor/.planning/phases/06-data-pipeline-integration/06-02-SUMMARY.md
@sc-ethics-monitor/src/sheets_sync.py
@sc-ethics-monitor/src/config.py
@public/data/candidates.json

**Target Format (from existing candidates.json):**
```json
{
  "lastUpdated": "2026-01-21T15:28:37.958807Z",
  "house": {
    "1": {
      "districtNumber": 1,
      "candidates": [],
      "incumbent": {"name": "Bill Whitmire", "party": "Republican"}
    },
    "2": {
      "districtNumber": 2,
      "candidates": [
        {
          "name": "Duncan, Adam L",
          "party": "Republican",
          "status": "filed",
          "filedDate": "2025-07-24",
          "ethicsUrl": "...",
          "reportId": "407262",
          "source": "ethics",
          "isIncumbent": true
        }
      ],
      "incumbent": {"name": "Adam L. Duncan", "party": "Republican"}
    }
  },
  "senate": { ... }
}
```

**Source Data (Google Sheets):**
- Candidates tab: name, office, party, filing info
- Race Analysis tab: incumbent data per district
- Districts tab: district metadata
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export script structure</name>
  <files>sc-ethics-monitor/scripts/export_to_webapp.py</files>
  <action>
Create `scripts/export_to_webapp.py` with structure:

```python
#!/usr/bin/env python3
"""
Export SC Ethics Monitor data to webapp candidates.json format.

Reads from Google Sheets (Source of Truth) and generates
public/data/candidates.json for the Blue Intelligence webapp.
"""

import json
import sys
from datetime import datetime, timezone
from pathlib import Path

# Add src to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.sheets_sync import SheetsSync
from src.config import SC_HOUSE_DISTRICTS, SC_SENATE_DISTRICTS


def export_candidates(output_path: str = None, dry_run: bool = False):
    """
    Export candidates from Google Sheets to candidates.json.

    Args:
        output_path: Path to output file (default: public/data/candidates.json)
        dry_run: If True, print output but don't write file

    Returns:
        True if successful, False otherwise
    """
    # Implementation in Task 2
    pass


if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(description="Export to webapp")
    parser.add_argument("--dry-run", action="store_true", help="Print but don't write")
    parser.add_argument("--output", help="Output path (default: public/data/candidates.json)")
    args = parser.parse_args()

    success = export_candidates(output_path=args.output, dry_run=args.dry_run)
    sys.exit(0 if success else 1)
```
  </action>
  <verify>
Run: `cd sc-ethics-monitor && python scripts/export_to_webapp.py --help`
Should show help text with --dry-run and --output options
  </verify>
  <done>
Script structure created with CLI interface
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement export logic</name>
  <files>sc-ethics-monitor/scripts/export_to_webapp.py</files>
  <action>
Implement `export_candidates()` function:

1. Connect to Google Sheets via SheetsSync
2. Read Candidates tab to get all candidates with:
   - name, office (to extract chamber/district), final_party or detected_party
   - filing_date, ethics_url, report_id, source
3. Read Race Analysis or Districts tab to get incumbent data
4. Build output structure:
   ```python
   output = {
       "lastUpdated": datetime.now(timezone.utc).isoformat(),
       "house": {},
       "senate": {}
   }
   ```
5. For each district (1-124 House, 1-46 Senate):
   - Get incumbent from Race Analysis
   - Get filed candidates from Candidates tab
   - Add to appropriate chamber
6. Determine isIncumbent by comparing candidate name to incumbent
7. Write to output path (default: `../public/data/candidates.json`)

Handle edge cases:
- Candidates with no party → use null
- Districts with no candidates → empty list
- Name normalization for "Last, First" format
  </action>
  <verify>
Run: `cd sc-ethics-monitor && python scripts/export_to_webapp.py --dry-run`
Should print JSON structure without errors
  </verify>
  <done>
Export logic implemented with proper data transformation
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate and validate candidates.json</name>
  <files>public/data/candidates.json</files>
  <action>
1. Run export script to generate actual file:
   `cd sc-ethics-monitor && python scripts/export_to_webapp.py`

2. Validate output:
   - Has lastUpdated timestamp
   - Has house and senate sections
   - Each district has districtNumber, candidates array, incumbent object
   - Candidates have required fields (name, party, status, etc.)

3. Compare with existing candidates.json:
   - Same structure
   - More complete party data (from Phase 6 improvements)
   - All 28 filed candidates present
  </action>
  <verify>
Run: `cat public/data/candidates.json | python -c "import json,sys; d=json.load(sys.stdin); print(f'House districts: {len(d[\"house\"])}'); print(f'Senate districts: {len(d[\"senate\"])}')"`
Should show: House districts: 124, Senate districts: 46
  </verify>
  <done>
candidates.json generated with all 170 districts and 28 candidates
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `scripts/export_to_webapp.py` exists and runs without errors
- [ ] `public/data/candidates.json` generated with correct structure
- [ ] All 28 candidates from Google Sheet present in output
- [ ] Incumbent data present for all districts
- [ ] Party data reflects Phase 6 improvements (>75% known)
</verification>

<success_criteria>
- Export script reads from Google Sheets and outputs to candidates.json
- Output format matches existing webapp expectations
- All candidate and incumbent data preserved
- Script can be run on-demand or integrated into monitor.py
</success_criteria>

<output>
After completion, create `sc-ethics-monitor/.planning/phases/06-data-pipeline-integration/06-03-SUMMARY.md`
</output>
