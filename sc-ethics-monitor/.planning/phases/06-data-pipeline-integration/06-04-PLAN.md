---
phase: 06-data-pipeline-integration
plan: 04
type: execute
depends_on: ["06-03"]
files_modified: [sc-ethics-monitor/src/monitor.py]
---

<objective>
Integrate webapp export into monitor.py workflow with --export-webapp flag.

Purpose: Currently, export must be run manually as a separate script. Integrating into monitor.py ensures export happens automatically after sync operations, keeping the webapp data fresh.

Output: `python -m src.monitor --export-webapp` triggers export after sync.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@sc-ethics-monitor/.planning/PROJECT.md
@sc-ethics-monitor/.planning/ROADMAP.md
@sc-ethics-monitor/.planning/phases/06-data-pipeline-integration/06-03-SUMMARY.md
@sc-ethics-monitor/src/monitor.py
@sc-ethics-monitor/scripts/export_to_webapp.py

**Current monitor.py flags:**
- --dry-run: Test without sending emails
- --skip-scrape: Use cached scrape data
- --force-discovery: Run candidate discovery now
- --scrape-data: Path to ethics JSON
- --incumbents: Path to incumbents JSON
- --credentials: Path to credentials

**Integration Point:**
After sync completes (candidates updated in Google Sheets), call export_to_webapp.py logic.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --export-webapp flag to argparse</name>
  <files>sc-ethics-monitor/src/monitor.py</files>
  <action>
In the `main()` function, add a new argument:

```python
parser.add_argument(
    "--export-webapp",
    action="store_true",
    help="Export candidates.json to public/data/ after sync"
)
```

This flag will trigger the export step at the end of the monitor workflow.
  </action>
  <verify>
Run: `cd sc-ethics-monitor && python -m src.monitor --help | grep export-webapp`
Should show: --export-webapp  Export candidates.json to public/data/ after sync
  </verify>
  <done>
--export-webapp flag added to CLI
  </done>
</task>

<task type="auto">
  <name>Task 2: Import and call export function</name>
  <files>sc-ethics-monitor/src/monitor.py</files>
  <action>
1. Add import at top of monitor.py:
   ```python
   from pathlib import Path
   # Near other imports
   ```

2. Create a wrapper function for export:
   ```python
   def run_webapp_export(dry_run: bool = False) -> bool:
       """Export candidates to webapp candidates.json."""
       log("=" * 60)
       log("WEBAPP EXPORT")
       log("=" * 60)

       # Import here to avoid circular imports
       import sys
       scripts_dir = Path(__file__).parent.parent / "scripts"
       sys.path.insert(0, str(scripts_dir))

       try:
           from export_to_webapp import export_candidates
           output_path = str(Path(__file__).parent.parent.parent / "public" / "data" / "candidates.json")

           if dry_run:
               log("  DRY RUN: Would export to " + output_path)
               return True

           success = export_candidates(output_path=output_path)
           if success:
               log(f"  Exported to {output_path}")
           else:
               log("  Export failed!")
           return success
       except ImportError as e:
           log(f"  Error: Could not import export_to_webapp: {e}")
           return False
       except Exception as e:
           log(f"  Export error: {e}")
           return False
   ```

3. In `main()`, after sync completes, add:
   ```python
   if args.export_webapp:
       export_success = run_webapp_export(dry_run=args.dry_run)
       if not export_success:
           log("Warning: Webapp export failed")
   ```
  </action>
  <verify>
Run: `cd sc-ethics-monitor && python -m src.monitor --dry-run --skip-scrape --export-webapp 2>&1 | grep -i export`
Should show export-related log messages
  </verify>
  <done>
Export function integrated into monitor workflow
  </done>
</task>

<task type="auto">
  <name>Task 3: Test end-to-end workflow</name>
  <files>sc-ethics-monitor/src/monitor.py</files>
  <action>
Test the full workflow:

1. Dry run test:
   ```bash
   cd sc-ethics-monitor
   python -m src.monitor --dry-run --skip-scrape --export-webapp
   ```
   Should show sync steps + export step without making changes

2. Actual run (if credentials available):
   ```bash
   python -m src.monitor --skip-scrape --export-webapp
   ```
   Should update Google Sheets and generate public/data/candidates.json

3. Verify candidates.json updated:
   ```bash
   ls -la ../public/data/candidates.json
   head -20 ../public/data/candidates.json
   ```

Document any issues or edge cases encountered.
  </action>
  <verify>
Run full workflow and check:
- Monitor completes without errors
- candidates.json has recent lastUpdated timestamp
- All 28 candidates present in output
  </verify>
  <done>
End-to-end workflow tested: sync + export works
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `--export-webapp` flag recognized by CLI
- [ ] Export function called after sync when flag present
- [ ] Dry run shows export would happen without writing
- [ ] Actual run generates updated candidates.json
</verification>

<success_criteria>
- `python -m src.monitor --export-webapp` exports after sync
- Works with `--dry-run` for testing
- Error handling prevents export failures from crashing monitor
- Logging shows export status
</success_criteria>

<output>
After completion, create `sc-ethics-monitor/.planning/phases/06-data-pipeline-integration/06-04-SUMMARY.md`
</output>
