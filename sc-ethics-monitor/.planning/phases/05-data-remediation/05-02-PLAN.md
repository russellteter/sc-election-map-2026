---
phase: 05-data-remediation
plan: 02
type: standard
---

# Plan 05-02: Fix Race Analysis Aggregation

<objective>
Fix the Race Analysis tab so it shows actual candidate counts instead of all zeros.

Purpose: Currently all 170 rows show dem_candidates=0, rep_candidates=0, other_candidates=0, race_status="Unknown". The `update_race_analysis()` function is not counting candidates correctly.

Output: Race Analysis tab shows accurate candidate counts per district and correct race_status values.
</objective>

<context>
@.planning/phases/05-data-remediation/DESIGN.md
@src/sheets_sync.py
@scripts/run_party_detection.py
</context>

<tasks>

<task type="auto" id="1">
  <name>Analyze current update_race_analysis() logic</name>
  <action>
    Read `src/sheets_sync.py` and examine `update_race_analysis()`:
    - How does it read candidate data?
    - How does it group by district_id?
    - How does it count by party?
    - What is the race_status calculation logic?

    Document the current implementation flow.
  </action>
  <verify>Current logic documented with line numbers</verify>
  <done>Understand exactly what the function is doing (or not doing)</done>
</task>

<task type="auto" id="2">
  <name>Identify aggregation bug</name>
  <action>
    Add debug logging to `update_race_analysis()`:
    - Log candidates read from Candidates tab
    - Log grouping by district_id
    - Log party counting per district
    - Log race_status calculation

    Run and examine output to find where counts become zero.
  </action>
  <verify>Debug output shows where the aggregation fails</verify>
  <done>Exact bug location identified</done>
</task>

<task type="auto" id="3">
  <name>Fix candidate reading logic</name>
  <action>
    Ensure `update_race_analysis()` correctly:
    1. Reads ALL rows from Candidates tab (not just first N)
    2. Extracts district_id from correct column
    3. Extracts final_party from correct column (L, not detected_party)
    4. Handles empty/null values gracefully
  </action>
  <verify>Function reads all 28+ candidates correctly</verify>
  <done>Candidate reading returns accurate data</done>
</task>

<task type="auto" id="4">
  <name>Fix grouping and counting logic</name>
  <action>
    Fix the aggregation:
    1. Group candidates by district_id (e.g., "SC-House-042")
    2. For each district:
       - Count candidates where final_party = "D" -> dem_candidates
       - Count candidates where final_party = "R" -> rep_candidates
       - Count candidates where final_party in ("I", "O", "UNKNOWN") -> other_candidates
    3. Total should match number of candidates for that district
  </action>
  <verify>Counts match manual verification of sample districts</verify>
  <done>Party counts aggregate correctly per district</done>
</task>

<task type="auto" id="5">
  <name>Fix race_status calculation</name>
  <action>
    Implement correct race_status logic:
    - "Contested-D" = has D candidates, no R candidates
    - "Contested-R" = has R candidates, no D candidates
    - "Competitive" = has both D and R candidates
    - "Open" = no filed candidates (needs incumbent check)
    - "Unknown" = insufficient data

    Update the race_status calculation in `update_race_analysis()`.
  </action>
  <verify>race_status values reflect actual candidate mix</verify>
  <done>race_status correctly categorizes each district</done>
</task>

<task type="auto" id="6">
  <name>Re-run Race Analysis update</name>
  <action>
    Execute the fixed function:
    ```bash
    cd /Users/russellteter/Desktop/sc-election-map-2026/sc-ethics-monitor
    python -c "from src.sheets_sync import SheetsSync; s = SheetsSync(); s.update_race_analysis()"
    ```

    Or run via monitor script if that's the entry point.
  </action>
  <verify>Google Sheet Race Analysis tab shows non-zero values</verify>
  <done>Race Analysis updated with actual counts</done>
</task>

<task type="auto" id="7">
  <name>Verify counts are correct</name>
  <action>
    Manual verification:
    1. Pick 5 sample districts with known candidates
    2. Verify dem_candidates count matches actual D candidates
    3. Verify rep_candidates count matches actual R candidates
    4. Verify race_status reflects the mix

    Document any discrepancies.
  </action>
  <verify>Sample verification passes for all 5 districts</verify>
  <done>Counts verified accurate on sample districts</done>
</task>

</tasks>

<verification>
- [ ] Current `update_race_analysis()` logic documented
- [ ] Bug causing all-zeros identified
- [ ] Candidate reading logic fixed
- [ ] Grouping and counting logic fixed
- [ ] race_status calculation implemented
- [ ] Race Analysis tab shows non-zero counts
- [ ] Counts verified against actual candidates
</verification>

<success_criteria>
- Race Analysis shows actual candidate counts (not all zeros)
- dem_candidates + rep_candidates + other_candidates = total candidates per district
- race_status accurately reflects each district's competitive situation
- No errors during update execution
</success_criteria>

<output>
Create 05-02-SUMMARY.md documenting:
- Root cause of all-zeros bug
- Fixes implemented to sheets_sync.py
- Race Analysis statistics after fix:
  - Districts with D candidates
  - Districts with R candidates
  - Competitive districts (both D and R)
  - Open districts (no candidates)
</output>
